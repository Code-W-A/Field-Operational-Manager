# Firebase Functions pentru FOM

Acest director conține Firebase Functions pentru generarea automată a lucrărilor de revizie.

## Funcții Disponibile

### `generateScheduledWorks`
Funcție scheduled care rulează automat la orele:
- 8:00 dimineața
- 13:00 ziua  
- 17:00 seara

**Timezone:** Europe/Bucharest

**Funcționalitate:**
- Verifică toate contractele cu recurență setată
- Pentru fiecare contract, calculează data următoarei revizii:
  - **Prima revizie**: Folosește `startDate` dacă este setată (data primei revizii)
  - **Revizii ulterioare**: Calculează bazat pe `lastAutoWorkGenerated`
  - Pentru recurență în **zile**: adaugă numărul de zile la ultima dată
  - Pentru recurență în **luni**: 
    - Adaugă numărul de luni la ultima dată
    - Dacă este setată `recurrenceDayOfMonth`, setează revizia în acea zi a lunii
    - Exemplu: "3 luni, ziua 15" → revizia va fi pe 15 ale lunii respective
    - **Notă**: Dacă ziua nu există în luna respectivă (ex: 31 februarie), se va folosi ultima zi din lună
- Creează automat lucrări neatribuite cu "X zile înainte" de data reviziei
- Marchează contractele cu `lastAutoWorkGenerated` pentru a evita duplicatele

## Setup

### 1. Instalare dependențe

```bash
cd firebase-functions
npm install
```

### 2. Build

```bash
npm run build
```

### 3. Test local cu Firebase Emulator

```bash
npm run serve
```

## Deploy

### Deploy toate funcțiile

```bash
npm run deploy
```

### Deploy funcție specifică

```bash
firebase deploy --only functions:generateScheduledWorks
```

## Structura Datelor

### Contract (cu recurență)

```typescript
{
  id: string
  name: string
  number: string
  clientId: string
  locationId: string
  locationName: string
  equipmentIds: string[]
  
  startDate?: string  // Ex: "2025-02-15" (data primei revizii)
  recurrenceInterval: number  // Ex: 90
  recurrenceUnit: 'zile' | 'luni'
  recurrenceDayOfMonth?: number  // Ex: 15 (doar pentru recurență lunară)
  daysBeforeWork: number  // Ex: 10
  
  lastAutoWorkGenerated?: string  // ISO date string
}
```

### Lucrare Generată Automat

```typescript
{
  client: string
  clientId: string
  dataInterventie: Timestamp  // Data reviziei
  tipLucrare: 'Revizie'
  locatie: string
  echipament: string
  echipamentCod: string
  descriere: string
  statusLucrare: 'Planificat'
  tehnicieni: []  // Neatribuită
  contractId: string
  autoGenerated: true
  createdBy: 'system'
}
```

## Loguri

### Vizualizare loguri

```bash
npm run logs
```

### Loguri în timp real

```bash
firebase functions:log --only generateScheduledWorks
```

## Monitoring

Funcția va loga:
- Numărul de contracte procesate
- Numărul de lucrări create
- Erori și avertismente

## Troubleshooting

### Funcția nu se execută

1. Verifică că funcția este deployed:
   ```bash
   firebase functions:list
   ```

2. Verifică logurile pentru erori:
   ```bash
   npm run logs
   ```

3. Verifică că există contracte cu recurență în baza de date

### Lucrări duplicate

Funcția folosește `lastAutoWorkGenerated` pentru a preveni duplicatele. Dacă totuși apar duplicate, verifică:
- Logurile pentru erori de actualizare a contractului
- Că funcția nu rulează în paralel (nu ar trebui, fiind scheduled)

## Cost Estimat

- Funcție scheduled: ~3 invocări/zi = ~90 invocări/lună
- Sub limita gratuită Firebase (125K invocări/lună)
- Citiri Firestore: depinde de numărul de contracte și echipamente

